
# 📘 CHAPTER 8 — 트랜잭션

## 1. 트랜잭션 특징

### 📌 트랜잭션이란?

트랜잭션이란, 데이터베이스에서 하나의 논리적인 작업 단위를 의미하며, 여러 SQL을 묶어 모두 성공하거나, 모두 실패하도록 보장하는 개념

트랜잭션은 4가지의 특징을 가지고 있음.

| 특징     | 설명        |
| ------ | ------------ |
| 원자성  | 작업의 부분들이 동시에 수행되거나 동시에 수행되지 않는 특성 |
| 일관성 | 다른 트랜잭션에 의해 테이블의 값이 수정되지 않는 특성 |
| 고립성 | 트랜잭션이 수행되는 동안에는 다른 외부 요소들의 간섭이 없어야하는 특성 |
| 지속성 | 잘 수행된 트랜잭션에 대한 데이터는 수정되거나 없어지지 않고 남아있는 특성 |

### 📌 Write-Ahead Logging (WAL) 파일이란?

- Log란, DBMS에서 변경되는 모든 작업들을 표시하고 기록하는 개념
- WAL 파일이란, 데이터 변경을 하기 전에 변경 사항을 미리 기록해두는 파일

---

## 2. 트랜잭션의 실행하기
### 📌 트랜잭션 기본 명령어

| 명령어     | 설명        |
| ------ | ------------ |
| BEGIN  | 새로운 트랜잭션을 실행 |
| COMMIT | 트랜잭션 수행이 끝난 후 변경된 결과를 저장 |
| ROLLBACK | 현재 수행되고 있는 트랜잭션을 중지하고 BEGIN 시점으로 데이터를 되돌림 |
| SAVEPOINT | 원하는 특정 지점을 기준으로 데이터를 저장 |
| ROLLBACK TO | 저장된 세이브 포인트로 데이터를 변경 |

```sql
BEGIN;
...
SAVEPOINT save_name;
...
ROLLBACK TO save_name;
...
ROLLBACK;
COMMIT;
```

### 📌 자동 커밋

PostgreSQL에서는 DML 명령어인 INSERT, UPDATE, DELETE와 같은 명령어는 따로 커밋을 쓰지 않아도 자동으로 커밋이 진행됨.

자동 커밋이 되는 것을 원치 않을 때에는 `\set AUTOCOMMIT off` 명령어 사용

---

## 2. 트랜잭션 고립화 수준

### 📌 트랜잭션 문제

| 문제 | 설명        |
| ------ | ------------ |
| 오손 읽기 (dirty read)  | 읽기 작업을 하는 트랜잭션 1이 쓰기 작업을 하는 트랜잭션 2가 작업한 중간 데이터를 읽기 때문에 생기는 문제 |
| 비반복적 읽기 (nonrepeatable read) | 트랜잭션 1이 데이터를 읽고 트랜잭션 2가 데이터를 쓰고(갱신, UPDATE) 트랜잭션 1이 다시 한 번 데이터를 읽을 때 생기는 문제 |
| 가상 읽기 (phantom read) | 트랜잭션 1이 데이터를 읽고 트랜잭션 2가 데이터를 쓰고(삽입, INSERT) 트랜잭션 1이 다시 한 번 데이터를 읽을 때 생기는 문제 |


### 📌 트랜잭션 고립화 수준

트랜잭션을 이러한 문제를 해결하기 위해 고립화 수준 개념을 사용함.

| 고립화 수준 | 명칭        | 특징 | 문제 |
| ------ | ------------ | --------- | --------- |
| 0 단계 | 실행되지 않는 읽기 (Read Uncommitted) | 트랜잭션에서 처리중인 데이터를 다른 트랜잭션이 읽는 것을 허용 | 오손 읽기, 비반복적 읽기, 가상 읽기 |
| 1 단계 | 실행된 읽기 (Read Committed) | 완료된 트랜잭션의 데이터만 읽는 것을 허용함 | 비반복적 읽기, 가상 읽기 |
| 2 단계 | 반복적 읽기 (Repeatable Read) | 먼저 실행된 트랜잭션이 종료될 때까지 뒤에 실행된 트랜잭션이 먼저 실행된 트랜잭션의 데이터를 수정하는 것을 허용하지 않음 | 가상 읽기 |
| 3 단계 | 직렬화 (Serializable) | 먼저 실행된 트랜잭션의 데이터를 뒤에 실행된 트랜잭션이 수정, 삭제, 생성하는 것을 허용하지 않음 |  |

- PostgreSQL은 기본 고립화 수준은 **1단계**임

### 📌 트랜잭션 고립화 수준과 성능의 관계

트랜잭션 **고립화 수준(Isolation Level)** 이 높아질수록 데이터 불일치 발생 확률 감소됨.  
동시 처리 방식보다 순차적이고 안전한 처리 방식에 가까워지기 때문임.

### 고립화 수준 상승 시 특징

- 데이터 충돌 가능성 감소됨  
- 데이터 일관성 증가됨  
- 동시 처리 감소됨 → 동시성(Concurrency) 저하됨  

### 성능 영향

동시성 감소되면 대기 시간 증가됨.  
처리 시간 증가됨 → 성능 저하됨.

### 고립화 수준이 낮을 경우

- 동시에 데이터 처리됨  
- 처리 속도 향상됨 → 성능 향상됨  
- 데이터 정합성 문제 발생 가능성 증가됨  

### 정리 요약

고립화 수준 ↑ → 안정성 증가, 성능 감소됨  
고립화 수준 ↓ → 성능 증가, 안정성 감소됨  
두 요소는 **트레이드 오프 관계**임.

---